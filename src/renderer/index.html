<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>3D Animation Viewer</title>
  <link rel="stylesheet" href="./styles.css">
</head>
<body>
  <!-- Drop Zone Overlay (hidden by default) -->
  <div id="drop-overlay" class="drop-overlay">
    <div class="drop-content">
      <p class="title is-3">Drop 3D Model Here</p>
      <p class="subtitle">Supported formats: GLB, GLTF, FBX</p>
    </div>
  </div>

  <!-- Notification Container -->
  <div id="notification-container" class="notification-container"></div>

  <!-- Main Layout -->
  <div class="app-container">
    <!-- Top Toolbar -->
    <nav class="navbar is-dark" role="navigation">
      <div class="navbar-brand">
        <span class="navbar-item">
          <strong>3D Animation Viewer</strong>
        </span>
      </div>
      <div class="navbar-menu">
        <div class="navbar-start">
          <div class="navbar-item">
            <div class="buttons">
              <button id="btn-open-model" class="button is-primary">
                <span class="icon"><span>üìÇ</span></span>
                <span>Open Model</span>
              </button>
              <button id="btn-export" class="button is-success" disabled>
                <span class="icon"><span>üíæ</span></span>
                <span>Export Frames</span>
              </button>
              <button id="btn-capture" class="button is-warning" disabled>
                <span class="icon"><span>üì∏</span></span>
                <span>Capture Frame</span>
              </button>
              <button id="btn-retarget" class="button is-info" disabled>
                <span class="icon"><span>üîÑ</span></span>
                <span>Retarget Animation</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </nav>

    <!-- Main Content Area -->
    <div class="main-content">
      <!-- Left Sidebar: Animation List -->
      <aside class="sidebar sidebar-left">
        <div class="sidebar-header">
          <p class="title is-6">Animations</p>
          <button id="btn-add-animation" class="button is-small is-primary" disabled style="margin-left: auto;">
            <span class="icon">‚ûï</span>
            <span>Add</span>
          </button>
        </div>
        <div id="animation-list" class="animation-list">
          <div class="empty-state">
            <p class="has-text-grey">No model loaded</p>
          </div>
        </div>
      </aside>

      <!-- Center: 3D Viewport -->
      <div class="viewport-container">
        <canvas id="webgl-canvas"></canvas>
        <div id="empty-state" class="empty-state-overlay">
          <div class="empty-state-content">
            <p class="title is-4">Drop a 3D model here</p>
            <p class="subtitle is-6">or click "Open Model" to browse</p>
            <p class="has-text-grey">Supported formats: GLB, GLTF, FBX</p>
          </div>
        </div>
        <div id="loading-overlay" class="loading-overlay" style="display: none;">
          <div class="loading-content">
            <div class="loader"></div>
            <p class="loading-text">Loading model...</p>
          </div>
        </div>
      </div>

      <!-- Right Sidebar: Scene Controls -->
      <aside class="sidebar sidebar-right">
        <div class="sidebar-header">
          <p class="title is-6">Scene Controls</p>
        </div>
        <div class="control-section">
          <label class="label">Background Color</label>
          <div class="field">
            <div class="control">
              <input type="color" id="bg-color" class="input color-input-fullwidth" value="#2c3e50">
            </div>
          </div>
        </div>

        <div class="control-section">
          <label class="label">Camera Preset</label>
          <div class="select is-fullwidth">
            <select id="camera-preset">
              <option value="perspective">Perspective</option>
              <option value="front">Front View</option>
              <option value="back">Back View</option>
              <option value="left">Left View</option>
              <option value="right">Right View</option>
              <option value="top">Top View</option>
              <option value="bottom">Bottom View</option>
            </select>
          </div>
        </div>

        <div class="control-section">
          <label class="label">
            <input type="checkbox" id="grid-toggle" checked> Show Grid
          </label>
        </div>

        <div class="control-section">
          <label class="label">Light Position</label>
          <div class="field">
            <label class="label is-small">X: <span id="light-x-value">5</span></label>
            <input type="range" id="light-x" class="slider" min="-20" max="20" step="0.5" value="5">
          </div>
          <div class="field">
            <label class="label is-small">Y: <span id="light-y-value">10</span></label>
            <input type="range" id="light-y" class="slider" min="-20" max="20" step="0.5" value="10">
          </div>
          <div class="field">
            <label class="label is-small">Z: <span id="light-z-value">7.5</span></label>
            <input type="range" id="light-z" class="slider" min="-20" max="20" step="0.5" value="7.5">
          </div>
        </div>

        <div class="control-section">
          <label class="label">Light Intensity</label>
          <div class="field">
            <label class="label is-small">Directional: <span id="dir-light-value">0.8</span></label>
            <input type="range" id="dir-light-intensity" class="slider" min="0" max="2" step="0.1" value="0.8">
          </div>
          <div class="field">
            <label class="label is-small">Ambient: <span id="amb-light-value">0.4</span></label>
            <input type="range" id="amb-light-intensity" class="slider" min="0" max="1" step="0.1" value="0.4">
          </div>
        </div>

        <div id="model-info" class="control-section" style="display: none;">
          <label class="label">Model Info</label>
          <div class="model-info-content">
            <p><strong>Name:</strong> <span id="info-name">-</span></p>
            <p><strong>Polygons:</strong> <span id="info-polygons">-</span></p>
            <p><strong>Animations:</strong> <span id="info-animations">-</span></p>
            <p><strong>Bones:</strong> <span id="info-bones">-</span></p>
          </div>
        </div>
      </aside>
    </div>

    <!-- Bottom Timeline Panel -->
    <div class="timeline-panel">
      <div class="timeline-controls">
        <button id="btn-play" class="button is-small is-success" disabled>
          <span class="icon">‚ñ∂</span>
        </button>
        <button id="btn-pause" class="button is-small is-warning" disabled>
          <span class="icon">‚è∏</span>
        </button>
        <button id="btn-stop" class="button is-small is-danger" disabled>
          <span class="icon">‚èπ</span>
        </button>
        <label class="checkbox ml-3">
          <input type="checkbox" id="loop-toggle"> Loop
        </label>
        <span class="timeline-time ml-3">
          <span id="current-time">00:00:00</span> / <span id="total-time">00:00:00</span>
        </span>
      </div>
      <div class="timeline-scrubber">
        <input type="range" id="time-slider" class="slider is-fullwidth" min="0" max="1" step="0.001" value="0" disabled>
      </div>
    </div>
  </div>

  <!-- Export Modal -->
  <div id="export-modal" class="modal">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">Export Animation Frames</p>
        <button class="delete" aria-label="close"></button>
      </header>
      <section class="modal-card-body">
        <div class="field">
          <label class="label">Resolution</label>
          <div class="select is-fullwidth">
            <select id="export-resolution">
              <option value="128x128">128x128</option>
              <option value="256x256">256x256</option>
              <option value="512x512">512x512</option>
              <option value="1024x1024" selected>1024x1024</option>
              <option value="2048x2048">2048x2048</option>
              <option value="4096x4096">4096x4096</option>
              <option value="custom">Custom</option>
            </select>
          </div>
        </div>
        <div id="custom-resolution" class="field" style="display: none;">
          <div class="field-body">
            <div class="field">
              <label class="label">Size</label>
              <input type="number" id="export-size" class="input" value="1024" min="1" placeholder="Square resolution">
            </div>
          </div>
        </div>
        <div class="field">
          <label class="label">Frame Rate (FPS)</label>
          <div class="select is-fullwidth">
            <select id="export-fps">
              <option value="24">24 FPS</option>
              <option value="30" selected>30 FPS</option>
              <option value="60">60 FPS</option>
              <option value="custom">Custom</option>
            </select>
          </div>
        </div>
        <div id="custom-fps" class="field" style="display: none;">
          <label class="label">Custom FPS</label>
          <input type="number" id="export-fps-custom" class="input" value="30" min="1" max="120">
        </div>
        <div class="field">
          <label class="label">Output Folder</label>
          <div class="field has-addons">
            <div class="control is-expanded">
              <input type="text" id="export-folder" class="input" readonly placeholder="Choose folder...">
            </div>
            <div class="control">
              <button id="btn-choose-folder" class="button is-info">Browse</button>
            </div>
          </div>
        </div>
        <div class="field">
          <label class="checkbox">
            <input type="checkbox" id="transparent-bg-toggle">
            Transparent Background
          </label>
          <p class="help">Export with alpha channel (transparent background)</p>
        </div>
        <div class="notification is-info is-light">
          <p><strong>Frame naming:</strong> frame_001.png, frame_002.png, ...</p>
        </div>
      </section>
      <footer class="modal-card-foot">
        <button id="btn-start-export" class="button is-success" disabled>Start Export</button>
        <button class="button">Cancel</button>
      </footer>
    </div>
  </div>

  <!-- Export Progress Modal -->
  <div id="progress-modal" class="modal">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">Exporting Frames</p>
      </header>
      <section class="modal-card-body">
        <p id="progress-text">Exporting frame 0 of 0...</p>
        <progress id="progress-bar" class="progress is-success" value="0" max="100">0%</progress>
        <p id="progress-eta" class="has-text-grey">Estimating time remaining...</p>
      </section>
      <footer class="modal-card-foot">
        <button id="btn-cancel-export" class="button is-danger">Cancel</button>
      </footer>
    </div>
  </div>

  <!-- Capture Frame Modal -->
  <div id="capture-modal" class="modal">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">Capture Current Frame</p>
        <button class="delete" aria-label="close"></button>
      </header>
      <section class="modal-card-body">
        <div class="field">
          <label class="label">Resolution</label>
          <div class="select is-fullwidth">
            <select id="capture-resolution">
              <option value="128x128">128x128</option>
              <option value="256x256">256x256</option>
              <option value="512x512">512x512</option>
              <option value="1024x1024" selected>1024x1024</option>
              <option value="2048x2048">2048x2048</option>
              <option value="4096x4096">4096x4096</option>
              <option value="custom">Custom</option>
            </select>
          </div>
        </div>
        <div id="capture-custom-resolution" class="field" style="display: none;">
          <label class="label">Size</label>
          <input type="number" id="capture-size" class="input" value="1024" min="1" placeholder="Square resolution">
        </div>
        <div class="field">
          <label class="label">Output Folder</label>
          <div class="field has-addons">
            <div class="control is-expanded">
              <input type="text" id="capture-folder" class="input" readonly placeholder="Choose folder...">
            </div>
            <div class="control">
              <button id="btn-choose-capture-folder" class="button is-info">Browse</button>
            </div>
          </div>
        </div>
        <div class="field">
          <label class="checkbox">
            <input type="checkbox" id="capture-transparent-bg-toggle">
            Transparent Background
          </label>
          <p class="help">Save with alpha channel (transparent background)</p>
        </div>
        <div class="notification is-info is-light">
          <p><strong>Output:</strong> Saved to snapshots/{yyyyMMddhhmmss}.png</p>
        </div>
      </section>
      <footer class="modal-card-foot">
        <button id="btn-do-capture" class="button is-warning" disabled>Capture Frame</button>
        <button class="button">Cancel</button>
      </footer>
    </div>
  </div>

  <!-- Retarget Animation Modal -->
  <div id="retarget-modal" class="modal modal-large">
    <div class="modal-background"></div>
    <div class="modal-card modal-card-large">
      <header class="modal-card-head">
        <p class="modal-card-title">Animation Retargeting</p>
        <button class="delete" aria-label="close"></button>
      </header>
      <section class="modal-card-body">
        <!-- Model Selection -->
        <div class="notification is-info is-light">
          <p><strong>Instructions:</strong> Load a second model to use as the retarget destination. The current model will be the source.</p>
        </div>
        
        <div class="field">
          <label class="label">Load Target Model</label>
          <button id="btn-load-target-model" class="button is-primary">
            <span class="icon">üìÇ</span>
            <span>Load Target Model</span>
          </button>
        </div>

        <!-- Rig Type Info -->
        <div class="columns" style="margin-top: 1rem;">
          <div class="column">
            <div class="box">
              <p class="label">Source Model</p>
              <p><strong>Rig Type:</strong> <span id="source-rig-type">-</span></p>
              <p><strong>Bones:</strong> <span id="source-bone-count">-</span></p>
            </div>
          </div>
          <div class="column">
            <div class="box">
              <p class="label">Target Model</p>
              <p><strong>Rig Type:</strong> <span id="target-rig-type">-</span></p>
              <p><strong>Bones:</strong> <span id="target-bone-count">-</span></p>
            </div>
          </div>
        </div>

        <!-- Bone Mapping Controls -->
        <div class="field is-grouped" style="margin-top: 1rem;">
          <div class="control">
            <button id="btn-auto-map" class="button is-success" disabled>
              <span class="icon">ü§ñ</span>
              <span>Auto Map Bones</span>
            </button>
          </div>
          <div class="control">
            <button id="btn-clear-mapping" class="button is-warning" disabled>
              <span class="icon">üóëÔ∏è</span>
              <span>Clear Mapping</span>
            </button>
          </div>
          <div class="control">
            <button id="btn-save-mapping" class="button is-info" disabled>
              <span class="icon">üíæ</span>
              <span>Save Mapping</span>
            </button>
          </div>
          <div class="control">
            <button id="btn-load-mapping" class="button is-info" disabled>
              <span class="icon">üì•</span>
              <span>Load Mapping</span>
            </button>
          </div>
        </div>

        <!-- Mapping Info -->
        <div id="mapping-info" class="notification is-light" style="margin-top: 1rem; display: none;">
          <p><strong>Mapped Bones:</strong> <span id="mapped-bone-count">0</span></p>
          <p><strong>Confidence:</strong> <span id="mapping-confidence">0%</span></p>
        </div>

        <!-- Bone Trees -->
        <div class="columns" style="margin-top: 1rem;">
          <div class="column">
            <label class="label">Source Skeleton</label>
            <div id="source-bone-tree" class="bone-tree-container">
              <p class="has-text-grey">Load a model to see bones</p>
            </div>
          </div>
          <div class="column">
            <label class="label">Target Skeleton</label>
            <div id="target-bone-tree" class="bone-tree-container">
              <p class="has-text-grey">Load target model to see bones</p>
            </div>
          </div>
        </div>

        <!-- Manual Mapping Controls -->
        <div class="box" style="margin-top: 1rem;">
          <p class="label">Manual Mapping</p>
          <div class="field is-grouped">
            <div class="control is-expanded">
              <input type="text" id="selected-source-bone" class="input" readonly placeholder="Click source bone...">
            </div>
            <div class="control">
              <button id="btn-create-mapping" class="button is-primary" disabled>‚Üí</button>
            </div>
            <div class="control is-expanded">
              <input type="text" id="selected-target-bone" class="input" readonly placeholder="Click target bone...">
            </div>
          </div>
        </div>

        <!-- Current Mappings -->
        <div class="box" style="margin-top: 1rem; max-height: 200px; overflow-y: auto;">
          <p class="label">Current Bone Mappings</p>
          <div id="bone-mapping-list">
            <p class="has-text-grey">No mappings yet</p>
          </div>
        </div>

        <!-- Animation Selection -->
        <div class="field" style="margin-top: 1rem;">
          <label class="label">Select Animations to Retarget</label>
          <div id="retarget-animation-list" class="retarget-animation-list">
            <p class="has-text-grey">No animations available</p>
          </div>
        </div>
      </section>
      <footer class="modal-card-foot">
        <button id="btn-apply-retarget" class="button is-success" disabled>Apply Retargeting</button>
        <button class="button">Close</button>
      </footer>
    </div>
  </div>

  <!-- Save Mapping Modal -->
  <div id="save-mapping-modal" class="modal">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">Save Bone Mapping</p>
        <button class="delete" aria-label="close"></button>
      </header>
      <section class="modal-card-body">
        <div class="field">
          <label class="label">Mapping Name</label>
          <input type="text" id="mapping-name-input" class="input" placeholder="e.g., Mixamo to UE5">
        </div>
      </section>
      <footer class="modal-card-foot">
        <button id="btn-confirm-save-mapping" class="button is-success">Save</button>
        <button class="button">Cancel</button>
      </footer>
    </div>
  </div>

  <!-- Load Mapping Modal -->
  <div id="load-mapping-modal" class="modal">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">Load Bone Mapping</p>
        <button class="delete" aria-label="close"></button>
      </header>
      <section class="modal-card-body">
        <div class="field">
          <label class="label">Available Mappings</label>
          <div id="available-mappings-list" class="available-mappings-list">
            <p class="has-text-grey">Loading...</p>
          </div>
        </div>
      </section>
      <footer class="modal-card-foot">
        <button class="button">Close</button>
      </footer>
    </div>
  </div>

  <!-- Add Animation Modal -->
  <div id="add-animation-modal" class="modal">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">Add Animation from File</p>
        <button class="delete" aria-label="close"></button>
      </header>
      <section class="modal-card-body">
        <div class="notification is-info is-light">
          <p><strong>Load an animation file (FBX/GLTF) to add animations to your current model.</strong></p>
          <p class="help">The bone structure must match your current model.</p>
        </div>
        
        <div class="field">
          <label class="label">Load Animation File</label>
          <button id="btn-load-animation-file" class="button is-primary">
            <span class="icon">üìÇ</span>
            <span>Browse Animation File</span>
          </button>
        </div>

        <div id="animation-file-info" style="display: none; margin-top: 1rem;">
          <div class="box">
            <p class="label">File Information</p>
            <p><strong>File:</strong> <span id="anim-file-name">-</span></p>
            <p><strong>Animations Found:</strong> <span id="anim-file-count">-</span></p>
            <p><strong>Bones:</strong> <span id="anim-file-bones">-</span></p>
          </div>

          <!-- Bone Structure Verification -->
          <div id="bone-verification" class="box">
            <p class="label">Bone Structure Verification</p>
            <div id="bone-verification-result">
              <p class="has-text-grey">Verifying...</p>
            </div>
          </div>

          <!-- Retargeting Section (shown when bones don't match) -->
          <div id="retargeting-section" style="display: none;">
            <div class="notification is-warning is-light">
              <p><strong>‚ö† Bone structures don't match perfectly.</strong></p>
              <p class="help">Use retargeting to adapt animations to your model's skeleton.</p>
            </div>

            <div class="field is-grouped" style="margin-bottom: 1rem;">
              <div class="control">
                <button id="btn-auto-map-inline" class="button is-success is-small">
                  <span class="icon">ü§ñ</span>
                  <span>Auto-Map Bones</span>
                </button>
              </div>
              <div class="control">
                <button id="btn-clear-mapping-inline" class="button is-warning is-small" disabled>
                  <span class="icon">üóëÔ∏è</span>
                  <span>Clear Mapping</span>
                </button>
              </div>
              <div class="control">
                <button id="btn-toggle-bone-trees" class="button is-info is-small">
                  <span class="icon">üå≤</span>
                  <span>Show Bone Trees</span>
                </button>
              </div>
            </div>

            <!-- Bone Mapping Info -->
            <div id="inline-mapping-info" class="box" style="display: none;">
              <p><strong>Mapped Bones:</strong> <span id="inline-mapped-count">0</span></p>
              <p><strong>Confidence:</strong> <span id="inline-mapping-confidence">0%</span></p>
            </div>

            <!-- Bone Trees (collapsible) -->
            <div id="inline-bone-trees" style="display: none; margin-top: 1rem;">
              <div class="columns">
                <div class="column">
                  <label class="label is-small">Your Model Bones</label>
                  <div id="inline-current-model-tree" class="bone-tree-container-small">
                    <p class="has-text-grey">Loading...</p>
                  </div>
                </div>
                <div class="column">
                  <label class="label is-small">Animation File Bones</label>
                  <div id="inline-animation-file-tree" class="bone-tree-container-small">
                    <p class="has-text-grey">Loading...</p>
                  </div>
                </div>
              </div>

              <!-- Manual Mapping -->
              <div class="box" style="margin-top: 0.5rem;">
                <p class="label is-small">Manual Mapping</p>
                <div class="field is-grouped is-grouped-multiline">
                  <div class="control is-expanded">
                    <input type="text" id="inline-selected-current-bone" class="input is-small" readonly placeholder="Click your model bone...">
                  </div>
                  <div class="control">
                    <button id="btn-create-mapping-inline" class="button is-primary is-small" disabled>‚Üí</button>
                  </div>
                  <div class="control is-expanded">
                    <input type="text" id="inline-selected-anim-bone" class="input is-small" readonly placeholder="Click animation bone...">
                  </div>
                </div>
              </div>

              <!-- Current Mappings List -->
              <div class="box" style="margin-top: 0.5rem; max-height: 150px; overflow-y: auto;">
                <p class="label is-small">Current Mappings</p>
                <div id="inline-mapping-list">
                  <p class="has-text-grey is-size-7">No mappings yet</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Animation Selection -->
          <div id="animation-selection-container" style="display: none;">
            <div class="field">
              <label class="label">Select Animations to Add</label>
              <div id="animation-selection-list" class="animation-selection-list">
                <!-- Animation checkboxes will be added here -->
              </div>
            </div>
          </div>
        </div>
      </section>
      <footer class="modal-card-foot">
        <button id="btn-add-selected-animations" class="button is-success" disabled>Add Selected Animations</button>
        <button class="button">Cancel</button>
      </footer>
    </div>
  </div>

  <script type="module" src="./renderer.js"></script>
</body>
</html>
